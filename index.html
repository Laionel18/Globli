<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Globli 2.0 - Vida Virtual</title>
    <style>
        :root {
            --primary: #4ECDC4;
            --accent: #FF6B6B;
            --dark: #2C3E50;
            --globli-skin: #00A896;
            --bg-living: #E0EAFC;
            --bg-kitchen: #FFF5E1;
            --bg-bath: #D4F1F4;
            --bg-bed: #2c3e50; /* Oscuro por defecto noche */
            --bg-bed-day: #F3E5F5;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background: #333;
            height: 100vh;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        #app {
            width: 100%; max-width: 480px; height: 100%; max-height: 900px;
            background: var(--bg-living);
            position: relative; display: flex; flex-direction: column;
            transition: background 0.5s ease;
            overflow: hidden;
        }

        /* --- UI Overlay --- */
        .top-ui {
            padding: 10px; background: rgba(255,255,255,0.8);
            border-bottom: 2px solid rgba(0,0,0,0.1); z-index: 20;
            display: flex; flex-direction: column; gap: 5px;
        }
        
        .bars { display: flex; gap: 5px; justify-content: space-around; }
        .bar-wrap { flex: 1; height: 10px; background: #ddd; border-radius: 5px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.5s, background 0.5s; }
        .icon { font-size: 1.2rem; margin-right: 2px; }

        .coins-badge {
            position: absolute; top: 10px; right: 10px;
            background: gold; padding: 5px 10px; border-radius: 20px;
            font-weight: bold; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 25;
        }

        /* --- Game World --- */
        #game-world {
            flex: 1; position: relative;
            display: flex; justify-content: center; align-items: center;
        }

        /* GLOBILI CHARACTER */
        #globli {
            width: 180px; height: 180px;
            background: radial-gradient(circle at 30% 30%, #40E0D0, var(--globli-skin));
            border-radius: 50% 50% 45% 45%;
            position: relative;
            box-shadow: inset -10px -10px 20px rgba(0,0,0,0.2), 0 10px 20px rgba(0,0,0,0.2);
            animation: breathe 3s infinite ease-in-out;
            transition: transform 0.2s, filter 0.5s;
            cursor: pointer; z-index: 10;
        }

        #globli.dirty-overlay::after {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: radial-gradient(#6d4c41 20%, transparent 20%);
            background-size: 50px 50px; opacity: 0.7; border-radius: inherit;
            pointer-events: none;
        }
        
        #globli.soaped::before {
            content: ''; position: absolute; top:-10px; left:-10px; right:-10px; bottom:-10px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="white" opacity="0.5"/></svg>');
            border-radius: 50%; opacity: 0.8; animation: bubbleFloat 5s linear infinite;
            pointer-events: none;
        }

        .eyes { position: absolute; top: 35%; width: 100%; display: flex; justify-content: center; gap: 25px; }
        .eye { width: 45px; height: 50px; background: white; border-radius: 50%; position: relative; overflow: hidden; }
        .pupil { width: 20px; height: 22px; background: #222; border-radius: 50%; position: absolute; top: 14px; left: 12px; transition: all 0.2s; }
        .mouth {
            width: 30px; height: 15px; border-bottom: 5px solid #222; border-radius: 0 0 20px 20px;
            position: absolute; bottom: 25%; left: 50%; transform: translateX(-50%); transition: all 0.3s;
        }

        /* Estados Emocionales */
        .sad .mouth { border-bottom: none; border-top: 5px solid #222; border-radius: 20px 20px 0 0; bottom: 20%; }
        .sad .eye { height: 40px; border-radius: 50% 50% 40% 40%; }
        .happy .eye { height: 40px; border-radius: 50% 50% 40% 40%; margin-top: 10px; }
        .happy .mouth { width: 40px; height: 20px; }
        .sleeping .eye { height: 5px; background: transparent; border-bottom: 4px solid #333; border-radius: 0; margin-top: 25px; }
        .sleeping .pupil { display: none; }
        .sleeping { animation: sleepFloat 4s infinite ease-in-out !important; filter: brightness(0.8); }

        /* --- Room Objects --- */
        .room-obj { position: absolute; pointer-events: none; transition: all 0.3s; }
        
        /* Poop */
        .poop {
            position: absolute; font-size: 2.5rem; cursor: pointer; z-index: 5;
            animation: bounce 2s infinite; pointer-events: auto;
        }
        
        /* Bathroom Tools */
        .tool-rack {
            position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; gap: 20px;
            display: none; /* Solo visible en ba√±o */
        }
        .bath-tool {
            width: 70px; height: 70px; background: white; border-radius: 15px;
            display: flex; justify-content: center; align-items: center; font-size: 2.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: grab; z-index: 50; touch-action: none;
        }
        .bath-tool.dragging { position: fixed; transform: scale(1.2); opacity: 0.9; cursor: grabbing; pointer-events: none; }

        /* Bedroom */
        .lamp-switch {
            position: absolute; top: 20px; right: 20px; width: 40px; height: 60px;
            background: #eee; border: 2px solid #ccc; border-radius: 5px; cursor: pointer;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .switch-knob { width: 10px; height: 20px; background: #333; border-radius: 2px; transition: transform 0.2s; }
        .dark-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,10, 0.85); pointer-events: none; opacity: 0; transition: opacity 1s; z-index: 15;
        }

        /* Kitchen */
        .fridge-btn {
            position: absolute; top: 15%; right: 10%; width: 100px; height: 180px;
            background: #dfe6e9; border: 4px solid #b2bec3; border-radius: 10px;
            cursor: pointer; display: none; text-align: center; padding-top: 20px;
            box-shadow: inset -10px 0 20px rgba(0,0,0,0.1);
        }
        .fridge-handle { width: 8px; height: 40px; background: #b2bec3; position: absolute; left: 10px; top: 50%; }

        /* --- Navigation --- */
        .nav-bar {
            background: white; padding: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;
            border-top: 2px solid #eee; z-index: 30;
        }
        .nav-btn {
            background: transparent; border: none; font-size: 1.5rem; cursor: pointer; opacity: 0.5;
            display: flex; flex-direction: column; align-items: center;
        }
        .nav-btn span { font-size: 0.7rem; font-weight: bold; }
        .nav-btn.active { opacity: 1; color: var(--primary); transform: scale(1.1); }

        /* --- Modals/Shop --- */
        .modal {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); z-index: 100; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; width: 90%; max-height: 80%; overflow-y: auto;
            border-radius: 15px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            text-align: center;
        }
        .grid-shop { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .shop-item {
            border: 2px solid #eee; border-radius: 10px; padding: 10px; cursor: pointer; position: relative;
        }
        .shop-item:active { background: #f0f0f0; transform: scale(0.98); }
        .qty-badge { position: absolute; top:5px; right:5px; background: var(--accent); color:white; font-size:0.7rem; padding: 2px 6px; border-radius: 10px; }

        /* Animations */
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        @keyframes sleepFloat { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-5px) scale(1.02); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes bubbleFloat { 0% { background-position: 0 0; } 100% { background-position: 0 -100px; } }
        .hearts-anim { position: absolute; color: #ff0000; font-size: 1.5rem; animation: floatUp 1s forwards; pointer-events: none; font-weight: bold; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity:1; } 100% { transform: translateY(-50px) scale(1.5); opacity:0; } }

    </style>
</head>
<body>

<div id="app">
    <div class="top-ui">
        <div class="coins-badge">üí∞ <span id="coin-disp">0</span></div>
        <div class="bars">
            <div class="bar-wrap"><div class="bar-fill" id="bar-hp" style="background:#FF6B6B"></div></div> <div class="bar-wrap"><div class="bar-fill" id="bar-hg" style="background:#F1C40F"></div></div> </div>
        <div class="bars">
            <div class="bar-wrap"><div class="bar-fill" id="bar-hy" style="background:#3498DB"></div></div> <div class="bar-wrap"><div class="bar-fill" id="bar-sl" style="background:#9B59B6"></div></div> <div class="bar-wrap"><div class="bar-fill" id="bar-ha" style="background:#2ECC71"></div></div> </div>
    </div>

    <div id="game-world">
        <div class="dark-overlay" id="night-overlay"></div>
        <div class="fridge-btn" id="fridge" onclick="game.ui.openFridge()">‚ùÑÔ∏è<div class="fridge-handle"></div></div>
        <div class="lamp-switch" id="lamp" onclick="game.actions.toggleLight()"><div class="switch-knob" id="knob"></div></div>
        
        <div id="poop-container"></div>

        <div id="globli" onclick="game.actions.pet(event)">
            <div class="eyes">
                <div class="eye"><div class="pupil"></div></div>
                <div class="eye"><div class="pupil"></div></div>
            </div>
            <div class="mouth"></div>
        </div>

        <div class="tool-rack" id="bath-tools">
            <div class="bath-tool" id="tool-soap" onmousedown="dragStart(event, 'soap')" ontouchstart="dragStart(event, 'soap')">üßº</div>
            <div class="bath-tool" id="tool-shower" onmousedown="dragStart(event, 'shower')" ontouchstart="dragStart(event, 'shower')">üöø</div>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn" onclick="game.setRoom('living')">üéÆ<span>Sala</span></button>
        <button class="nav-btn" onclick="game.setRoom('kitchen')">üçΩÔ∏è<span>Cocina</span></button>
        <button class="nav-btn" onclick="game.setRoom('bathroom')">üõÅ<span>Ba√±o</span></button>
        <button class="nav-btn" onclick="game.setRoom('bedroom')">üõå<span>Cuarto</span></button>
    </div>

    <div class="modal" id="modal-main">
        <div class="modal-content" id="modal-body">
            </div>
    </div>

    <div id="drag-proxy" style="position:fixed; pointer-events:none; z-index:999; font-size:3rem; display:none;"></div>
</div>

<script>
    /* --- MOTOR DE AUDIO (Web Audio API) --- */
    const audio = {
        ctx: new (window.AudioContext || window.webkitAudioContext)(),
        play(type) {
            if(this.ctx.state === 'suspended') this.ctx.resume();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain); gain.connect(this.ctx.destination);
            
            const now = this.ctx.currentTime;
            
            if (type === 'pop') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(1200, now+0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.1);
                osc.start(now); osc.stop(now+0.1);
            } else if (type === 'eat') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(400, now+0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.15);
                osc.start(now); osc.stop(now+0.15);
            } else if (type === 'sad') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(100, now+0.4);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.4);
                osc.start(now); osc.stop(now+0.4);
            } else if (type === 'happy') {
                osc.type = 'sine';
                [523, 659, 784].forEach((f, i) => {
                    const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                    o.connect(g); g.connect(this.ctx.destination);
                    o.frequency.value = f;
                    g.gain.setValueAtTime(0.05, now + i*0.1); g.gain.linearRampToValueAtTime(0, now + i*0.1 + 0.2);
                    o.start(now + i*0.1); o.stop(now + i*0.1 + 0.2);
                });
            } else if (type === 'shower') {
                // White noise approximation for shower
                const bufferSize = this.ctx.sampleRate * 0.2; // 0.2 seconds
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                const noiseFilter = this.ctx.createBiquadFilter();
                noiseFilter.type = 'lowpass'; noiseFilter.frequency.value = 800;
                noise.connect(noiseFilter); noiseFilter.connect(gain);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.2);
                noise.start(now);
            }
        }
    };

    /* --- L√ìGICA DEL JUEGO --- */
    const game = {
        data: {
            stats: { health: 100, hunger: 100, hygiene: 100, energy: 100, happiness: 100 },
            coins: 100,
            inventory: { 'pizza': 2, 'burger': 1, 'apple': 5, 'sushi': 0, 'icecream': 1 },
            lastSave: Date.now(),
            isSleeping: false,
            soapedLevel: 0, // 0-100
        },
        currentRoom: 'living',

        init() {
            this.load();
            this.setRoom('living');
            this.loop = setInterval(() => this.tick(), 2000); // Game tick cada 2s
            this.render();
        },

        load() {
            const saved = localStorage.getItem('globli2_save');
            if(saved) this.data = JSON.parse(saved);
        },
        
        save() {
            this.data.lastSave = Date.now();
            localStorage.setItem('globli2_save', JSON.stringify(this.data));
        },

        tick() {
            const s = this.data.stats;
            
            // Degradaci√≥n natural (si no duerme)
            if (!this.data.isSleeping) {
                s.hunger = Math.max(0, s.hunger - 1);
                s.hygiene = Math.max(0, s.hygiene - 0.8);
                s.energy = Math.max(0, s.energy - 0.5);
                s.happiness = Math.max(0, s.happiness - 0.5);
            } else {
                // Regeneraci√≥n durmiendo
                s.energy = Math.min(100, s.energy + 5);
                s.hunger = Math.max(0, s.hunger - 0.5); // Da hambre dormir
            }

            // Salud impactada por necesidades cr√≠ticas
            if(s.hunger < 20 || s.hygiene < 20 || s.energy < 10) s.health = Math.max(0, s.health - 1);
            else s.health = Math.min(100, s.health + 1);

            // Generar caquita
            if(s.hygiene < 40 && Math.random() < 0.3) this.spawnPoop();

            this.save();
            this.render();
        },

        setRoom(room) {
            this.currentRoom = room;
            const app = document.getElementById('app');
            const btns = document.querySelectorAll('.nav-btn');
            
            // Background Colors
            const colors = { 'living': '#E0EAFC', 'kitchen': '#FFF5E1', 'bathroom': '#D4F1F4', 'bedroom': '#F3E5F5' };
            app.style.background = this.data.isSleeping && room === 'bedroom' ? '#2c3e50' : colors[room];

            // Toggle Visuals
            document.getElementById('fridge').style.display = (room === 'kitchen') ? 'block' : 'none';
            document.getElementById('bath-tools').style.display = (room === 'bathroom') ? 'flex' : 'none';
            document.getElementById('lamp').style.display = (room === 'bedroom') ? 'flex' : 'none';
            document.getElementById('poop-container').style.display = (room === 'bathroom') ? 'block' : 'none'; // Poop only visible in bath? No, let's keep it clean, poop needs cleaning in bath context usually, but let's make it appear everywhere or just bathroom? Let's say hygiene implies bathroom needs. Let's show poops in all rooms or just stick to visual overlay. Actually, showing poop in Bathroom makes sense for cleaning.
            document.getElementById('poop-container').style.display = 'block'; // Poop everywhere!

            // Update Nav State
            btns.forEach(b => b.classList.remove('active'));
            if(room === 'living') btns[0].classList.add('active');
            if(room === 'kitchen') btns[1].classList.add('active');
            if(room === 'bathroom') btns[2].classList.add('active');
            if(room === 'bedroom') btns[3].classList.add('active');
            
            // Adjust Globli Position slightly
            const g = document.getElementById('globli');
            g.style.transform = (room === 'bedroom') ? 'scale(0.9) translateY(20px)' : 'scale(1)';

            this.render();
        },

        actions: {
            pet(e) {
                if(game.data.isSleeping) return;
                game.data.stats.happiness = Math.min(100, game.data.stats.happiness + 5);
                game.data.coins += 1;
                audio.play('pop');
                
                // Visual FX
                const heart = document.createElement('div');
                heart.innerText = '‚ù§Ô∏è';
                heart.className = 'hearts-anim';
                heart.style.left = e.clientX + 'px';
                heart.style.top = e.clientY + 'px';
                document.body.appendChild(heart);
                setTimeout(() => heart.remove(), 1000);
                
                game.render();
            },

            toggleLight() {
                game.data.isSleeping = !game.data.isSleeping;
                const knob = document.getElementById('knob');
                const overlay = document.getElementById('night-overlay');
                
                if(game.data.isSleeping) {
                    knob.style.transform = 'translateY(20px)';
                    overlay.style.opacity = 1;
                    document.getElementById('app').style.background = '#2c3e50';
                } else {
                    knob.style.transform = 'translateY(0px)';
                    overlay.style.opacity = 0;
                    document.getElementById('app').style.background = '#F3E5F5';
                }
                game.render();
            },

            feed(item) {
                if(game.data.inventory[item] > 0) {
                    game.data.inventory[item]--;
                    
                    // Stats
                    const vals = {
                        'pizza': { h: 30, hp: 5 }, 'burger': { h: 40, hp: 2 },
                        'apple': { h: 10, hp: 5 }, 'sushi': { h: 20, hp: 15 },
                        'icecream': { h: 5, hp: 20 }
                    };
                    
                    game.data.stats.hunger = Math.min(100, game.data.stats.hunger + vals[item].h);
                    game.data.stats.happiness = Math.min(100, game.data.stats.happiness + vals[item].hp);
                    
                    // Poop risk
                    game.data.stats.hygiene -= 5;

                    audio.play('eat');
                    game.ui.closeModal();
                    game.render();
                    
                    // Animation
                    const g = document.getElementById('globli');
                    g.style.transform = "scale(1.1)";
                    setTimeout(() => game.setRoom('kitchen'), 200); // Reset scale logic via setRoom
                }
            },
            
            cleanPoop(el) {
                el.remove();
                game.data.stats.hygiene = Math.min(100, game.data.stats.hygiene + 5);
                game.data.coins += 2;
                audio.play('pop');
                game.render();
            }
        },

        spawnPoop() {
            const container = document.getElementById('poop-container');
            if(container.children.length > 5) return;
            
            const p = document.createElement('div');
            p.className = 'poop';
            p.innerText = 'üí©';
            // Posici√≥n aleatoria cerca del suelo
            p.style.left = (Math.random() * 80 + 10) + '%';
            p.style.top = (Math.random() * 100 + 200) + 'px'; // Offset relative to container
            p.onclick = function() { game.actions.cleanPoop(this); };
            container.appendChild(p);
        },

        render() {
            const s = this.data.stats;
            
            // Bars
            document.getElementById('bar-hp').style.width = s.health + '%';
            document.getElementById('bar-hg').style.width = s.hunger + '%';
            document.getElementById('bar-hy').style.width = s.hygiene + '%';
            document.getElementById('bar-sl').style.width = s.energy + '%';
            document.getElementById('bar-ha').style.width = s.happiness + '%';
            document.getElementById('coin-disp').innerText = this.data.coins;

            // Globli Look
            const g = document.getElementById('globli');
            g.className = ''; // Reset
            
            if (this.data.isSleeping) g.classList.add('sleeping');
            else {
                if (s.happiness < 40 || s.hunger < 30 || s.health < 40) g.classList.add('sad');
                else if (s.happiness > 80 && s.hunger > 80) g.classList.add('happy');
            }
            
            if (s.hygiene < 50) g.classList.add('dirty-overlay');
            if (this.data.soapedLevel > 0) g.classList.add('soaped');
        },

        ui: {
            openFridge() {
                const inv = game.data.inventory;
                let html = `<h2>Nevera</h2><div class="grid-shop">`;
                
                const foods = [
                    {id: 'apple', icon: 'üçé', n: 'Manzana'}, {id: 'pizza', icon: 'üçï', n: 'Pizza'},
                    {id: 'burger', icon: 'üçî', n: 'Burguer'}, {id: 'sushi', icon: 'üç£', n: 'Sushi'},
                    {id: 'icecream', icon: 'üç¶', n: 'Helado'}
                ];

                foods.forEach(f => {
                    if(inv[f.id] > 0) {
                        html += `<div class="shop-item" onclick="game.actions.feed('${f.id}')">
                            <span class="qty-badge">${inv[f.id]}</span>
                            <div style="font-size:2rem">${f.icon}</div>
                            <div>${f.n}</div>
                        </div>`;
                    }
                });
                
                html += `</div><br><button onclick="game.ui.openShop()" style="width:100%; padding:10px;">üõí Ir a la Tienda</button>`;
                html += `<br><br><button onclick="game.ui.closeModal()">Cerrar</button>`;
                
                document.getElementById('modal-body').innerHTML = html;
                document.getElementById('modal-main').style.display = 'flex';
            },

            openShop() {
                let html = `<h2>Supermercado</h2><p>Tienes: üí∞${game.data.coins}</p><div class="grid-shop">`;
                const items = [
                    {id: 'apple', icon: 'üçé', n: 'Manzana', p: 5},
                    {id: 'pizza', icon: 'üçï', n: 'Pizza', p: 15},
                    {id: 'burger', icon: 'üçî', n: 'Burguer', p: 20},
                    {id: 'sushi', icon: 'üç£', n: 'Sushi', p: 30},
                    {id: 'icecream', icon: 'üç¶', n: 'Helado', p: 10}
                ];

                items.forEach(i => {
                    html += `<div class="shop-item" onclick="game.ui.buy('${i.id}', ${i.p})">
                        <div style="font-size:2rem">${i.icon}</div>
                        <div>${i.n}</div>
                        <div style="color:var(--accent); font-weight:bold">${i.p} G</div>
                    </div>`;
                });
                
                html += `</div><br><button onclick="game.ui.openFridge()">‚¨Ö Volver a Nevera</button>`;
                document.getElementById('modal-body').innerHTML = html;
            },

            buy(id, price) {
                if(game.data.coins >= price) {
                    game.data.coins -= price;
                    game.data.inventory[id]++;
                    audio.play('pop');
                    game.save();
                    this.openShop(); // Refresh
                } else {
                    audio.play('sad');
                }
            },

            closeModal() {
                document.getElementById('modal-main').style.display = 'none';
            }
        }
    };

    /* --- INTERACTIVIDAD DE ARRASTRAR (BA√ëO) --- */
    let draggedItem = null;
    const proxy = document.getElementById('drag-proxy');
    const globliRect = () => document.getElementById('globli').getBoundingClientRect();

    function dragStart(e, type) {
        e.preventDefault();
        draggedItem = type;
        proxy.style.display = 'block';
        proxy.innerText = type === 'soap' ? 'üßº' : 'üöø';
        moveProxy(e.touches ? e.touches[0] : e);
    }

    function moveProxy(e) {
        proxy.style.left = (e.clientX - 30) + 'px';
        proxy.style.top = (e.clientY - 30) + 'px';
    }

    // Global Listeners for Drag
    window.addEventListener('mousemove', e => { if(draggedItem) { moveProxy(e); checkCollision(e); } });
    window.addEventListener('touchmove', e => { if(draggedItem) { moveProxy(e.touches[0]); checkCollision(e.touches[0]); } }, {passive: false});
    
    window.addEventListener('mouseup', () => { draggedItem = null; proxy.style.display = 'none'; });
    window.addEventListener('touchend', () => { draggedItem = null; proxy.style.display = 'none'; });

    function checkCollision(e) {
        const gr = globliRect();
        // Verificar si el cursor est√° sobre Globli
        if (e.clientX >= gr.left && e.clientX <= gr.right && e.clientY >= gr.top && e.clientY <= gr.bottom) {
            
            if (draggedItem === 'soap') {
                if(game.data.soapedLevel < 100) {
                    game.data.soapedLevel += 2;
                    audio.play('pop'); // Sonido burbujas
                    if(game.data.soapedLevel > 20) game.render(); // Actualiza visual
                }
            }
            
            if (draggedItem === 'shower') {
                audio.play('shower');
                if(game.data.soapedLevel > 0) {
                    // Enjuagando
                    game.data.soapedLevel -= 3;
                    game.data.stats.hygiene = Math.min(100, game.data.stats.hygiene + 2);
                    if(game.data.stats.hygiene >= 100) {
                        game.data.coins += 5;
                        game.data.stats.happiness += 10;
                        draggedItem = null; // Stop
                        proxy.style.display = 'none';
                        audio.play('happy');
                    }
                }
                game.render();
            }
        }
    }

    // Inicializar
    game.init();

</script>
</body>
</html>
